## 静态资源优化方案
> 学习文章出处: https://www.zhihu.com/question/20790576/answer/32602154

![avatar](/imgs/deploy-project.jpg)

### 方案内容
> 用文件的摘要信息来对资源文件进行重命名，
> 把摘要信息放到资源文件发布路径中，
> 这样，内容有修改的资源就变成了一个新的文件发布到线上，不会覆盖已有的资源文件。
> 上线过程中，先全量部署静态资源，再灰度部署页面

### 优点
1. 配置超长时间的本地缓存 —— ==节省带宽，提高性能==
2. 采用内容摘要作为缓存更新依据 —— ==精确的缓存控制==
3. 静态资源CDN部署 —— ==优化网络请求==
4. 更资源发布路径实现非覆盖式发布 —— ==平滑升级==

### 解析
* 本地缓存：利用304（协商缓存），让浏览器使用本地缓存。
* 内容摘要：利用`数据摘要要算法`对文件求摘要信息，
           摘要信息与文件内容一一对应，就有了一种可以精确到单个文件粒度的缓存控制依据，
           即哪个文件内容有更改就更新哪个文件
           而非摘要信息与版本对应，这样会导致所有链接都要更新
* 非覆盖式发布
```
// 方式a
http://static.xxx.com/a.css?v=0abc23

// 方式b
http://static.xxx.com/b_0abc23.css

```
###### 以方式a部署（不推荐）
* 先部署页面，再部署资源：
    * 在二者部署的时间间隔内，如果有用户访问页面，
    就会在新的页面结构中加载旧的资源，并且把这个旧版本的资源当做新版本缓存起来，
    其结果就是：用户访问到了一个样式错乱的页面，除非手动刷新，
    否则在资源缓存过期之前，页面会一直执行错误。
* 先部署资源，再部署页面：
    * 在部署时间间隔之内，有旧版本资源本地缓存的用户访问网站，
    * 由于请求的页面是旧版本的，资源引用没有改变，浏览器将直接使用本地缓存，这种情况下页面展现正常；
    * 但没有本地缓存或者缓存过期的用户访问网站，就会出现旧版本页面加载新版本资源的情况，导致页面执行错误，
    * 但当页面完成部署，这部分用户再次访问页面又会恢复正常了。

> 以上则为资源的覆盖式发布，用待发布的资源覆盖已发布的资源

###### 以方式b部署（推荐）
> 此为资源的非覆盖式发布

* cdn：内容分发网络( Content Delivery Network )把静态资源和动态网页分集群部署，静态资源会被部署到CDN节点上，提升网站性能
* 静态资源的缓存控制要求在前端所有静态资源加载的位置都要做这样的处理(样式中的图片应用，js文件等)

### [相关学习](https://github.com/fouber/blog)